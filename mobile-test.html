<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Catalog - New Architecture Test</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Montserrat', Arial, sans-serif;
            background: #f5f5f0;
            overflow: hidden;
        }
        
        #catalogContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        #catalogSvg {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, #ffffff 0%, #f0f0f0 100%);
        }
        
        .debug-info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            max-width: 300px;
        }
        
        .debug-info h4 {
            margin: 0 0 5px 0;
            color: #4CAF50;
        }
        
        .debug-info p {
            margin: 2px 0;
        }
        
        .navigation-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 1000;
        }
        
        .nav-button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s ease;
        }
        
        .nav-button:hover {
            background: #357abd;
        }
        
        .nav-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .breadcrumb {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="catalogContainer">
        <svg id="catalogSvg" viewBox="0 0 400 400">
            <g id="mainGroup">
                <g id="centralGroup"></g>
                <g id="topLevel"></g>
                <g id="pathLines"></g>
                <g id="focusRing"></g>
                <g id="detailItems"></g>
            </g>
        </svg>
    </div>
    
    <div class="debug-info" id="debugInfo">
        <h4>Mobile Catalog - New Architecture</h4>
        <p>Status: <span id="status">Initializing...</span></p>
        <p>Level: <span id="currentLevel">-</span></p>
        <p>Items: <span id="itemCount">-</span></p>
        <p>Rotation: <span id="rotation">0¬∞</span></p>
        <p>Focus Items: <span id="focusItemCount">-</span></p>
    </div>
    
    <div class="breadcrumb" id="breadcrumb">
        Home
    </div>
    
    <div class="navigation-controls">
        <button class="nav-button" id="backButton" onclick="navigateBack()" disabled>‚Üê Back</button>
        <button class="nav-button" id="resetButton" onclick="resetApp()">Reset</button>
        <button class="nav-button" id="statsButton" onclick="showStats()">Stats</button>
    </div>

    <script type="module">
        import { initMobileCatalog, mobileCatalogApp } from './mobile/mobile-app.js';
        
        let app = null;
        let updateInterval = null;
        
        // Initialize the app
        async function init() {
            try {
                document.getElementById('status').textContent = 'Loading...';
                
                await initMobileCatalog();
                app = window.mobileCatalogApp;
                
                if (app) {
                    document.getElementById('status').textContent = 'Initialized';
                    
                    // Set up event listeners
                    setupEventListeners();
                    
                    // Start debug info updates
                    startDebugUpdates();
                    
                } else {
                    throw new Error('App not initialized');
                }
                
            } catch (error) {
                console.error('Failed to initialize:', error);
                document.getElementById('status').textContent = 'Error: ' + error.message;
            }
        }
        
        function setupEventListeners() {
            if (!app) return;
            
            // Listen for state changes
            app.stateManager.addEventListener('navigationChanged', updateUI);
            app.stateManager.addEventListener('rotationChanged', updateRotation);
            app.stateManager.addEventListener('breadcrumbChanged', updateBreadcrumb);
        }
        
        function updateUI(event) {
            const { currentState } = event.detail;
            const context = app.stateManager.getCurrentContext();
            
            document.getElementById('currentLevel').textContent = currentState.currentLevel;
            document.getElementById('itemCount').textContent = context.itemCount;
            document.getElementById('backButton').disabled = !context.canNavigateBack;
        }
        
        function updateRotation(event) {
            const { rotation } = event.detail;
            const degrees = (rotation * 180 / Math.PI).toFixed(1);
            document.getElementById('rotation').textContent = degrees + '¬∞';
        }
        
        function updateBreadcrumb(event) {
            const { breadcrumb } = event.detail;
            const breadcrumbEl = document.getElementById('breadcrumb');
            
            if (breadcrumb.length === 0) {
                breadcrumbEl.textContent = 'Catalog';
            } else {
                breadcrumbEl.textContent = breadcrumb.map(item => item.label).join(' ‚Üí ');
            }
        }
        
        function startDebugUpdates() {
            updateInterval = setInterval(() => {
                if (!app) return;
                
                try {
                    const stats = app.getStats();
                    const summary = app.dataManager.getDataSummary();
                    
                    document.getElementById('focusItemCount').textContent = summary.manufacturers;
                    
                } catch (error) {
                    console.error('Error updating debug info:', error);
                }
            }, 1000);
        }
        
        // Global functions for buttons
        window.navigateBack = function() {
            if (app) {
                app.navigateToParent();
            }
        };
        
        window.resetApp = function() {
            if (app) {
                app.reset();
            }
        };
        
        window.showStats = function() {
            if (app) {
                const stats = app.getStats();
                const analytics = app.stateManager.getAnalytics();
                
                alert(`
Mobile Catalog Stats:
‚Ä¢ Level: ${stats.currentLevel}
‚Ä¢ Items: ${stats.currentItems}
‚Ä¢ Navigation Count: ${stats.navigationCount}
‚Ä¢ Session Duration: ${(analytics.sessionDuration / 1000).toFixed(1)}s
‚Ä¢ Rotation: ${(stats.rotation * 180 / Math.PI).toFixed(1)}¬∞
‚Ä¢ Rendering: ${stats.renderingEnabled ? 'Enabled' : 'Disabled'}
‚Ä¢ Interaction: ${stats.interactionEnabled ? 'Enabled' : 'Disabled'}
                `.trim());
            }
        };
        
        // Start initialization
        init();
    </script>
    
    <!-- Phase 1 Consolidation Test Script - Inline to avoid module scope issues -->
    <script>
        console.log('üß™ Loading bilingual coordinate test script...');
        
        // Phase 1 Consolidation Test: Bilingual Coordinate System  
        // Tests that new bilingual method produces same results as existing method

        // Test function to compare existing vs bilingual magnifying ring positioning
        function testBilingualCoordinates() {
            console.log('=== Phase 1 Consolidation Test: Bilingual Coordinates ===');
            
            try {
                // Get viewport manager instance from mobile app
                let viewportManager = null;
                
                if (window.mobileCatalogApp && window.mobileCatalogApp.viewport) {
                    viewportManager = window.mobileCatalogApp.viewport;
                    console.log('‚úì Found viewport manager in mobile app');
                } else if (window.viewportManager) {
                    viewportManager = window.viewportManager;
                    console.log('‚úì Found viewport manager in global scope');
                } else {
                    console.log('‚ùå Debug info:', {
                        mobileCatalogApp: !!window.mobileCatalogApp,
                        viewport: !!(window.mobileCatalogApp && window.mobileCatalogApp.viewport),
                        appKeys: window.mobileCatalogApp ? Object.keys(window.mobileCatalogApp) : 'no app'
                    });
                    throw new Error('ViewportManager not found. Make sure the mobile app is initialized.');
                }
                
                // Test existing method
                const existingPosition = viewportManager.getMagnifyingRingPosition();
                console.log('Existing method result:', existingPosition);
                
                // Test new bilingual method
                const bilingualPosition = viewportManager.getMagnifyingRingPositionBilingual();
                console.log('Bilingual method result:', bilingualPosition);
                
                // Compare positions (should be identical within floating point precision)
                const deltaX = Math.abs(existingPosition.x - bilingualPosition.x);
                const deltaY = Math.abs(existingPosition.y - bilingualPosition.y);
                const tolerance = 0.001;
                
                const positionsMatch = deltaX < tolerance && deltaY < tolerance;
                
                console.log('Position comparison:');
                console.log(`  Delta X: ${deltaX.toFixed(6)} (tolerance: ${tolerance})`);
                console.log(`  Delta Y: ${deltaY.toFixed(6)} (tolerance: ${tolerance})`);
                console.log(`  Positions match: ${positionsMatch ? '‚úì PASS' : '‚úó FAIL'}`);
                
                // Show coordinate representations
                if (bilingualPosition.hubCoord) {
                    console.log('Coordinate representations:');
                    console.log(`  Hub: ${bilingualPosition.hubCoord.toString()}`);
                }
                
                return positionsMatch;
                
            } catch (error) {
                console.error('Test failed:', error);
                return false;
            }
        }

        // Make sure it's available globally
        window.testBilingualCoordinates = testBilingualCoordinates;
        
        console.log('üìç Bilingual coordinate test script loaded inline');
        
        // Auto-run check after app loads
        setTimeout(() => {
            if (window.mobileCatalogApp && window.mobileCatalogApp.viewport) {
                console.log('üìç Bilingual coordinate test ready! Run testBilingualCoordinates() when ready.');
            } else {
                console.log('üìç Test loaded. Waiting for app to initialize...');
            }
        }, 3000);
    </script>
</body>
</html>